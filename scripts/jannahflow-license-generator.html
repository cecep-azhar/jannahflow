<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>JannahFlow â€” License Generator</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: #0f172a;
    color: #e2e8f0;
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem 1rem;
  }
  .card {
    background: #1e293b;
    border: 1px solid #334155;
    border-radius: 1.25rem;
    padding: 2.5rem;
    width: 100%;
    max-width: 600px;
    box-shadow: 0 25px 50px rgba(0,0,0,.5);
  }
  .logo {
    display: flex;
    align-items: center;
    gap: .75rem;
    margin-bottom: 2rem;
  }
  .logo-icon {
    width: 40px; height: 40px;
    background: linear-gradient(135deg, #6366f1, #a855f7);
    border-radius: .75rem;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.25rem;
  }
  .logo-text { font-size: 1.25rem; font-weight: 700; color: #f8fafc; }
  .logo-badge {
    font-size: .65rem; font-weight: 700;
    background: #fef08a; color: #713f12;
    padding: .2rem .5rem; border-radius: 9999px;
    letter-spacing: .05em;
  }
  h1 { font-size: 1.5rem; font-weight: 700; color: #f8fafc; margin-bottom: .5rem; }
  .subtitle { font-size: .875rem; color: #94a3b8; margin-bottom: 2rem; }
  .form-group { margin-bottom: 1.25rem; }
  label { display: block; font-size: .8rem; font-weight: 600; color: #94a3b8; margin-bottom: .5rem; letter-spacing: .05em; text-transform: uppercase; }
  input, select {
    width: 100%;
    padding: .75rem 1rem;
    background: #0f172a;
    border: 1px solid #334155;
    border-radius: .75rem;
    color: #f8fafc;
    font-size: .95rem;
    transition: border-color .2s;
    outline: none;
  }
  input:focus, select:focus { border-color: #6366f1; }
  input::placeholder { color: #475569; }
  .row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
  .key-info {
    display: flex; align-items: center; gap: .6rem;
    padding: .75rem 1rem;
    background: #0f172a;
    border: 1px solid #1e3a5f;
    border-radius: .75rem;
    font-size: .82rem;
    color: #64748b;
  }
  .key-info .lock { font-size: 1rem; }
  .key-info code { color: #a5f3fc; font-family: monospace; font-size: .78rem; letter-spacing: .03em; }
  .btn {
    width: 100%;
    padding: .85rem;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: #fff;
    border: none;
    border-radius: .75rem;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    margin-top: .5rem;
    transition: opacity .2s, transform .1s;
  }
  .btn:hover { opacity: .9; transform: translateY(-1px); }
  .btn:active { transform: translateY(0); }
  .btn:disabled { opacity: .5; cursor: not-allowed; transform: none; }
  .result { margin-top: 1.75rem; }
  .result-label {
    font-size: .8rem; font-weight: 600; color: #94a3b8;
    text-transform: uppercase; letter-spacing: .05em; margin-bottom: .5rem;
  }
  .token-box {
    background: #0f172a;
    border: 1px solid #334155;
    border-radius: .75rem;
    padding: 1rem;
    font-family: "Fira Mono", "Courier New", monospace;
    font-size: .75rem;
    color: #a5f3fc;
    word-break: break-all;
    line-height: 1.6;
  }
  .token-actions { display: flex; gap: .75rem; margin-top: .75rem; }
  .copy-btn {
    flex: 1;
    padding: .6rem;
    background: #1e3a5f;
    border: 1px solid #1d4ed8;
    border-radius: .6rem;
    color: #93c5fd;
    font-size: .85rem;
    font-weight: 600;
    cursor: pointer;
    transition: background .2s;
  }
  .copy-btn:hover { background: #1d4ed8; color: #fff; }
  .copied { background: #14532d !important; border-color: #16a34a !important; color: #86efac !important; }
  .meta {
    margin-top: 1rem;
    padding: .85rem 1rem;
    background: #0f172a;
    border: 1px solid #1e3a5f;
    border-radius: .75rem;
    font-size: .8rem;
    color: #64748b;
    display: flex; flex-direction: column; gap: .35rem;
  }
  .meta span { color: #94a3b8; }
  .meta strong { color: #e2e8f0; }
  .alert {
    padding: .85rem 1rem;
    border-radius: .75rem;
    font-size: .85rem;
    margin-top: 1rem;
  }
  .alert-err { background: #280a0a; border: 1px solid #991b1b; color: #fca5a5; }
  .divider { border: none; border-top: 1px solid #1e293b; margin: 1.75rem 0; }
  .hint { font-size: .75rem; color: #475569; margin-top: .4rem; }
</style>
</head>
<body>
<div class="card">
  <div class="logo">
    <div class="logo-icon">ğŸ•Œ</div>
    <span class="logo-text">JannahFlow</span>
    <span class="logo-badge">LICENSE GENERATOR</span>
  </div>

  <h1>Generate Pro License</h1>
  <p class="subtitle">Buat JWT license untuk aktivasi fitur PRO pada aplikasi JannahFlow keluarga pelanggan.</p>

  <div class="form-group">
    <label>Domain Aplikasi</label>
    <input id="domain" type="text" placeholder="contoh: localhost  atau  app.keluargabahagia.com" />
    <p class="hint">Harus sama persis dengan hostname tempat JannahFlow dijalankan (termasuk localhost).</p>
  </div>

  <div class="row">
    <div class="form-group">
      <label>Label / Nama Keluarga</label>
      <input id="label" type="text" placeholder="Keluarga Bahagia" />
    </div>
    <div class="form-group">
      <label>Masa Berlaku</label>
      <select id="expiry">
        <option value="">Selamanya (tidak kadaluarsa)</option>
        <option value="365">1 Tahun</option>
        <option value="730">2 Tahun</option>
        <option value="1825">5 Tahun</option>
      </select>
    </div>
  </div>

  <div class="form-group">
    <label>Signing Key</label>
    <div class="key-info">
      <span class="lock">ğŸ”</span>
      Kunci signing ter-<em>derive</em> dari master secret + domain.
      Token tiap domain bersifat <code>unik &amp; tidak dapat disilang</code>.
    </div>
  </div>

  <button class="btn" id="gen-btn" onclick="generate()">âš¡ Generate License Token</button>

  <div id="result" class="result" style="display:none">
    <hr class="divider" />
    <div class="result-label">âœ… JWT Token</div>
    <div class="token-box" id="token-display"></div>
    <div class="token-actions">
      <button class="copy-btn" id="copy-btn" onclick="copyToken()">ğŸ“‹ Salin Token</button>
    </div>
    <div class="meta" id="meta"></div>
  </div>

  <div id="error" class="alert alert-err" style="display:none"></div>
</div>

<script>
// â”€â”€â”€ Obfuscated master secret â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Master secret = "bahagiabersamacacubehinggajannah"
// Encoded: XOR with mask [0x17,0x2B,0x3C,0x5E,0x41,0x0F,0x22,0x1A] (repeating)
const _O = "754A543F26664378" + "72594F3F2C6E417B" +
           "745E5E3B29664C7D" + "704A563F2F614372";
const _M = [0x17, 0x2B, 0x3C, 0x5E, 0x41, 0x0F, 0x22, 0x1A];

function _deobfuscate() {
  const bytes = _O.match(/.{2}/g).map(h => parseInt(h, 16));
  return new Uint8Array(bytes.map((b, i) => b ^ _M[i % _M.length]));
}

// â”€â”€â”€ Derive a domain-specific signing key â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// derivedKey = HMAC-SHA256(masterSecret, domain)
// This means each domain gets a cryptographically unique signing key.
async function getDomainKey(domain) {
  const masterBytes = _deobfuscate();
  const masterKey = await crypto.subtle.importKey(
    'raw', masterBytes,
    { name: 'HMAC', hash: 'SHA-256' },
    false, ['sign']
  );
  const derived = await crypto.subtle.sign(
    'HMAC', masterKey, new TextEncoder().encode(domain)
  );
  return new Uint8Array(derived); // 32 bytes, unique per domain
}

// â”€â”€â”€ Minimal HS256 JWT signer using WebCrypto â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function b64url(str) {
  return btoa(str).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
}
function b64urlFromBytes(arr) {
  return btoa(String.fromCharCode(...arr))
    .replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
}

async function signJWT(header, payload, keyBytes) {
  const signingKey = await crypto.subtle.importKey(
    'raw', keyBytes,
    { name: 'HMAC', hash: 'SHA-256' },
    false, ['sign']
  );
  const headerB64  = b64url(JSON.stringify(header));
  const payloadB64 = b64url(JSON.stringify(payload));
  const input = `${headerB64}.${payloadB64}`;
  const sig   = await crypto.subtle.sign('HMAC', signingKey, new TextEncoder().encode(input));
  return `${input}.${b64urlFromBytes(new Uint8Array(sig))}`;
}

// â”€â”€â”€ UI Logic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let generatedToken = '';

async function generate() {
  const domain  = document.getElementById('domain').value.trim().toLowerCase();
  const label   = document.getElementById('label').value.trim();
  const expDays = document.getElementById('expiry').value;
  const errEl   = document.getElementById('error');
  const resEl   = document.getElementById('result');

  errEl.style.display = 'none';
  resEl.style.display = 'none';

  if (!domain) { showError('Domain tidak boleh kosong.'); return; }
  if (!label)  { showError('Nama / Label keluarga tidak boleh kosong.'); return; }

  const btn = document.getElementById('gen-btn');
  btn.disabled = true;
  btn.textContent = 'â³ Generating...';

  try {
    const now = Math.floor(Date.now() / 1000);
    const payload = { domain, label, iss: 'jannahflow-cacube', iat: now };
    if (expDays) payload.exp = now + parseInt(expDays) * 86400;

    // Derive a signing key unique to this domain
    const domainKey = await getDomainKey(domain);

    generatedToken = await signJWT({ alg: 'HS256', typ: 'JWT' }, payload, domainKey);

    document.getElementById('token-display').textContent = generatedToken;

    const expText = expDays
      ? new Date((now + parseInt(expDays) * 86400) * 1000).toLocaleDateString('id-ID', { dateStyle: 'long' })
      : 'Tidak kadaluarsa';
    document.getElementById('meta').innerHTML = `
      <span>Domain: <strong>${domain}</strong></span>
      <span>Label: <strong>${label}</strong></span>
      <span>Dibuat: <strong>${new Date(now*1000).toLocaleString('id-ID')}</strong></span>
      <span>Kadaluarsa: <strong>${expText}</strong></span>
      <span style="color:#475569;font-size:.75rem">Signing key: <code style="color:#a5f3fc">HMAC-SHA256(masterSecret, "${domain}")</code></span>
    `;

    resEl.style.display = 'block';
    document.getElementById('copy-btn').classList.remove('copied');
    document.getElementById('copy-btn').textContent = 'ğŸ“‹ Salin Token';
  } catch (e) {
    showError('Gagal generate token: ' + e.message);
  } finally {
    btn.disabled = false;
    btn.textContent = 'âš¡ Generate License Token';
  }
}

async function copyToken() {
  if (!generatedToken) return;
  await navigator.clipboard.writeText(generatedToken);
  const btn = document.getElementById('copy-btn');
  btn.textContent = 'âœ… Tersalin!';
  btn.classList.add('copied');
  setTimeout(() => { btn.classList.remove('copied'); btn.textContent = 'ğŸ“‹ Salin Token'; }, 2500);
}

function showError(msg) {
  const el = document.getElementById('error');
  el.textContent = 'âŒ ' + msg;
  el.style.display = 'block';
}

document.addEventListener('keydown', (e) => { if (e.key === 'Enter') generate(); });
</script>
</body>
</html>
